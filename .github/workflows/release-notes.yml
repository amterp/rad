# GitHub Actions workflow for updating release notes in documentation
# Triggers when the Release workflow completes, updates docs, and deploys
#
# Note: Uses workflow_run instead of release trigger because releases created
# with GITHUB_TOKEN don't trigger other workflows (GitHub security feature).

name: Update Release Notes

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]

permissions:
  contents: write

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    # Only run if the Release workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Get release info
        id: release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Fetch latest release info via gh CLI since github.event.release
          # isn't available with workflow_run trigger
          TAG=$(gh release view --latest --json tagName -q '.tagName')
          DATE=$(gh release view --latest --json publishedAt -q '.publishedAt' | cut -d'T' -f1)
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT

      - name: Format release body
        id: format
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get release body via gh CLI
          gh release view --latest --json body -q '.body' > /tmp/raw_body.txt

          REPO_URL="https://github.com/${{ github.repository }}"

          # Convert commit hashes to links (e.g., "* 9e4e595 feat:" -> "- feat: ([9e4e595](url))")
          # Remove headers, carriage returns, and clean up formatting
          sed 's/\r$//' /tmp/raw_body.txt | \
            sed -E "s/^\* ([a-f0-9]{7,}) (.+)/- \2 ([\1](${REPO_URL}\/commit\/\1))/g" | \
            sed '/^## Changelog$/d' | \
            sed '/^## What'\''s Changed$/d' | \
            sed 's/^\*\*Full Changelog\*\*.*$//' | \
            sed '/^$/N;/^\n$/d' > /tmp/release_body.txt

      - name: Update releases.md
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          DATE="${{ steps.release.outputs.date }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${TAG}"

          # Create the new release section
          cat > /tmp/new_release.md << EOF
          ## [${TAG}](${RELEASE_URL}) - ${DATE}

          $(cat /tmp/release_body.txt)

          ---

          EOF

          # Insert after the intro section (after first "---" on its own line)
          awk '
            /^---$/ && !found {
              print
              found = 1
              print ""
              while ((getline line < "/tmp/new_release.md") > 0) print line
              next
            }
            { print }
          ' docs-web/docs/releases.md > /tmp/releases_new.md

          mv /tmp/releases_new.md docs-web/docs/releases.md

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs-web/docs/releases.md
          # Only commit if there are changes
          git diff --staged --quiet || git commit -m "docs: add release notes for ${{ steps.release.outputs.tag }}"

      - name: Push changes
        run: |
          git push origin main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install MkDocs
        run: pip install mkdocs-material

      - name: Deploy docs
        run: mkdocs gh-deploy --config-file docs-web/mkdocs.yml --force
